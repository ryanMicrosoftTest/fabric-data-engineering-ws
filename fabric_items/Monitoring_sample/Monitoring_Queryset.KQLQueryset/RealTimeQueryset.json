{
  "queryset": {
    "version": "1.0.0",
    "tabs": [
      {
        "id": "7f3980e8-137e-4935-aa9d-215d3a91acf5",
        "title": "Tab",
        "content": "// Welcome to \n\n// ███████╗ █████╗ ██████╗ ██████╗ ██╗ ██████╗ \n// ██╔════╝██╔══██╗██╔══██╗██╔══██╗██║██╔════╝  \n// █████╗  ███████║██████╔╝██████╔╝██║██║      \n// ██╔══╝  ██╔══██║██╔══██╗██ ██╔╝ ██║██║      \n// ██      ██║  ██║██████╔╝██ ███║ ██║╚██████\n// ╚═      ╚═╝  ╚═╝╚═╝     ╚   ══╝ ╚═╝ ╚═════╝ 's\n// Workspace Monitoring\n\n// ██╗  ██╗ ██████╗ ██╗     \n// ██║ ██╔╝██╔═══██╗██║     \n// █████╔╝ ██║   ██║██║     \n// ██╔═██╗ ██║   ██║██║     \n// ██║  ██╗╚██████╔╝███████╗\n// ╚═╝  ╚═╝ ╚═════╝ ╚══════╝\n// Query Set\n\n//------------------------------------\n// How to run Kusto queries in Fabric?\n//------------------------------------\n// You can run a query by placing the \n// cursor anywhere within the query\n// and clicking the run button \n// (or Shift + Enter).\n//------------------------------------\n\n//------------------------------------\n// What is KQL?\n//------------------------------------\n// Link: https://aka.ms/KQL_overview\n// Quick KQL reference guide can be \n// found here \n// https://aka.ms/kql-quick-reference\n//------------------------------------\n\n\n//------------------------------------\n// Let's start with some \n// Basic semantic model log analysis\n// Level 200\n//------------------------------------\n\n// Average query duration by day for the last available 5 days\nSemanticModelLogs\n| where OperationName == 'QueryEnd' \n| summarize AvgDurationSeconds = avg(DurationMs)/1000 by format_datetime(Timestamp, 'yyyy-MM-dd')\n| top 5 by Timestamp desc\n\n// Query count, distinctUsers, avgCPU, avgDuration by workspace for last 30d \nSemanticModelLogs \n| where Timestamp > ago(30d) \n| where OperationName == \"QueryEnd\"\n| summarize QueryCount=count() \n    ,Users = dcount(User)\nby WorkspaceId \n\n// Query duration percentiles for the last 3 days in 1 hour bins\nSemanticModelLogs \n| where Timestamp >= ago(3d) and Timestamp <= now() \n| where OperationName == 'QueryEnd' \n| summarize percentiles(DurationMs, 0.5, 0.9) by bin(Timestamp, 1h) \n\n// Refresh durations by workspace and semantic model for last 30d \nSemanticModelLogs \n| where Timestamp > ago(30d) \n| where OperationName == 'CommandEnd' \n| where User has \"Power BI Service\" \n| where EventText has \"refresh\" \n| project WorkspaceId, ItemName, DurationMs\n\n\n//------------------------------------\n// Let's continue with some advanced\n// semantic model performance analysis\n// Level 3-400\n//------------------------------------\n\n// Top 100 summarized and extracted Semantic Model engine logs (ExecutionMetrics) by OperationId\nlet ConvertQueryDialect = (enum: int) { case(enum == -1, 'Unknown', enum == 0, 'MDX', enum == 1, 'DMX', enum == 2, 'SQL', enum == 3, 'DAX', enum == 4, 'JSON', 'NA') };\nlet ConvertIntendedUsage = (enum: int) { case(enum == 0, 'Default', enum == 1, 'Scheduled', enum == 2, 'Interactive', enum == 3, 'Service', 'NA') };\nSemanticModelLogs\n    | where OperationId != '00000000-0000-0000-0000-000000000000'\n    | where ItemId != '' and isnotempty(ItemName)\n    | where OperationName == 'ExecutionMetrics'\n    | extend \n        e = parse_json(EventText),\n        ApplicationContext = todynamic(tostring(ApplicationContext))\n    | extend \n        ApplicationName = case(ApplicationName startswith 'PowerBI - Model Change Tracker', 'Power BI - Model Change Tracker', ApplicationName startswith 'Power BI Desktop', 'Power BI Desktop', ApplicationName startswith 'DAX Studio', 'DAX Studio', ApplicationName startswith 'Deployment Utility', 'Deployment Utility', ApplicationName startswith 'PowerBI - ExploreService', 'PowerBI - ExploreService', ApplicationName startswith 'Microsoft SQL Server Management Studio', 'Microsoft SQL Server Management Studio', ApplicationName startswith 'Tabular', 'TabularEditor', ApplicationName startswith 'PowerBI - NaturalLanguageService', 'PowerBI - NaturalLanguageService', ApplicationName startswith 'SQL Server Profiler', 'SQL Server Profiler', ApplicationName startswith 'Web Modeling', 'Web Modeling', ApplicationName)\n    | extend // Extend EventText\n    TimeStart = todatetime(e.timeStart),\n    TimeEnd = todatetime(e.timeEnd),\n    ApproximatePeakMemConsumptionKB = toint(e.approximatePeakMemConsumptionKB),\n    ExternalQueryExecutionTimeMs = toint(e.externalQueryExecutionTimeMs),\n    ExecutionDelayMs = toint(e.executionDelayMs),\n    VertipaqJobCpuTimeMs = toint(e.vertipaqJobCpuTimeMs),\n    CommandType = tostring(e.commandType),\n    ErrorCount = toint(e.errorCount),\n    DiscoverType = toint(e.discoverType),\n    RefreshParallelism = toint(e.refreshParallelism),\n    VertipaqTotalRows = toint(e.vertipaqTotalRows),\n    MEngineCpuTimeMs = toint(e.mEngineCpuTimeMs),\n    MEnginePeakMemoryKB = toint(e.mEnginePeakMemoryKB),\n    TabularConnectionTimeoutMs = toint(e.tabularConnectionTimeoutMs),\n    QueryResultRows = toint(e.queryResultRows),\n    QueryProcessingCpuTimeMs = toint(e.queryProcessingCpuTimeMs),\n    CapacityThrottlingMs = toint(e.capacityThrottlingMs),\n    DirectQueryRequestCount = toint(e.directQueryRequestCount),\n    DirectQueryTotalRows = toint(e.directQueryTotalRows),\n    DatasourceConnectionThrottleTimeMs = toint(e.datasourceConnectionThrottleTimeMs),\n    DirectQueryConnectionTimeMs = toint(e.directQueryConnectionTimeMs),\n    DirectQueryExecutionTimeMs = toint(e.directQueryExecutionTimeMs),\n    DirectQueryIterationTimeMs = toint(e.directQueryIterationTimeMs),\n    DirectQueryTotalTimeMs = toint(e.directQueryTotalTimeMs),\n    DirectQueryTimeoutMs = toint(e.directQueryTimeoutMs),\n    QueryDialect = ConvertQueryDialect(e.queryDialect),\n    IntendedUsage = ConvertIntendedUsage(e.intendedUsage),\n    Status = iif(e has 'errorCount', 'Failed', 'Succeeded'),\n    TotalCpuTimeMs = e.totalCpuTimeMs,\n    TotalDurationMs = e.durationMs\n    | extend // Extend Application Context\n        SemanticModelId = ApplicationContext.DatasetId,\n        ReportId = ApplicationContext.Sources.[0].ReportId,\n        VisualId = ApplicationContext.Sources.[0].VisualId,\n        Operation = ApplicationContext.Sources.[0].Operation,\n        ConsumptionMethod = ApplicationContext.Sources.[0].HostProperties.ConsumptionMethod,\n        UserSession = ApplicationContext.Sources.[0].HostProperties.UserSession\n    | summarize arg_max(Timestamp, *) by OperationId\n    | project\n        DateKey = bin(Timestamp, 1d),\n        OperationId,\n        ItemId,\n        ApplicationName,\n        ReplicaId,\n        User,\n        ExecutingUser,\n        QueryDialect,\n        IntendedUsage,\n        Status,\n        // Extracted EventText properties\n        TimeStart,\n        TimeEnd,\n        ApproximatePeakMemConsumptionKB,\n        ExternalQueryExecutionTimeMs,\n        ExecutionDelayMs,\n        VertipaqJobCpuTimeMs,\n        CommandType,\n        ErrorCount,\n        RefreshParallelism,\n        VertipaqTotalRows,\n        MEngineCpuTimeMs,\n        MEnginePeakMemoryKB,\n        TabularConnectionTimeoutMs,\n        QueryResultRows,\n        QueryProcessingCpuTimeMs,\n        CapacityThrottlingMs,\n        DirectQueryRequestCount,\n        DirectQueryTotalRows,\n        DatasourceConnectionThrottleTimeMs,\n        DirectQueryConnectionTimeMs,\n        DirectQueryExecutionTimeMs,\n        DirectQueryIterationTimeMs,\n        DirectQueryTotalTimeMs,\n        DirectQueryTimeoutMs,\n        TotalCpuTimeMs = todecimal(TotalCpuTimeMs),\n        TotalDurationMs = todecimal(TotalDurationMs),\n        // Extracted Application Context\n        SemanticModelId = tostring(SemanticModelId),\n        ReportId= tostring(ReportId),\n        VisualId = tostring(VisualId)\n| top 100 by DateKey desc \n\n\n//------------------------------------\n// AMAZING!\n// Very well done!\n//------------------------------------\n\n\n//------------------------------------------------------------------------------------------------------------\n// Are you interested in more?\n//------------------------------------------------------------------------------------------------------------\n// Take your workspace monitoring \n// to the next level\n// Download monitoring templates\n// from our Fabric Toolbox\n// https://github.com/microsoft/fabric-toolbox/tree/main/monitoring/workspace-monitoring-dashboards\n//------------------------------------------------------------------------------------------------------------\n\n",
        "dataSourceId": "4d9767bc-140b-4bf5-8d9c-cd38b877af51"
      }
    ],
    "dataSources": [
      {
        "type": "Fabric",
        "id": "4d9767bc-140b-4bf5-8d9c-cd38b877af51",
        "clusterUri": "",
        "databaseItemId": "1bf19e2d-6b2f-b6e0-49c5-4d4fe9d63cc5",
        "databaseItemName": "Monitoring_Database"
      }
    ]
  }
}